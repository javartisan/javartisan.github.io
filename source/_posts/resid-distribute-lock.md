---
title: 基于Redis实现的分布式锁
date: 2019-07-04 00:04:38
categories: Redis
---

分布式场景下，普遍存在同一资源的并发访问，因此对于资源需要进行同步操作，避免出现线程安全问题导致出具错乱，本节将会记录一下基于Redis实现分布式锁的相关细节。

<!-- more -->



**悲观锁：**

所谓的悲观锁，就是比较保守，一旦进行一些需要锁的操作，就立刻需要获取到锁才能执行，没有获取到锁则失败或者等待获取锁。

**乐观锁：**

乐观锁比悲观锁宽松，在执行需要加锁的操作时候，先假设获取到了锁，然后对需要进行副本修改，最后进行提交时候会去比对是否存在其他线程修改了数据，如果没有修改则提交，否则失败。

举例：

例如对于银行某一账户的高并发操作（假设只存在排他锁，不存在共享锁），如果有大量用户进行读取和修改操作，对于悲观锁当有大量用户进行读取操作时候每一个都需要进行获取锁会严重降低性能；但是使用乐观锁就可以缓解此问题（乐观锁一般都是基于数据的版本进行实现），例如A读取数据时，B写入数据，两者同时执行时候都会假设获取到乐观锁，因此都会进行操作，假设写操作先与读操作完成，此时就会修改数据版本，随后读操作完成之后会校验数据版本，此时会发现数据版本不一致，因此本次读取就会失败。



#### 分布式锁

​		通常对于一些并发有共享内存的程序而言，我们需要进行共享内存进行访问时进行并发控制，可以借助锁进行控制。按照锁的使用范围有操作系统级别的锁、语言级别的锁以及分布式锁。操作系统级别的锁的作用域为操作系统内部，语言级别的锁通常是进程级别的，而分布式锁则是运用在分布式场景下。



#### 基于Redis的分布式锁

​		锁其实就是可以简单理解为一个标记，可以在分布式场景下各个节点比较容易获取标记的状态值。因此可以借助Redis存储标记值以实现分布式锁。

- Redis提供的setnx指令就具有实现分布式锁的能力，但是需要格外开发实现一个功能健全的锁。
- Redis中还可以使用Watch命令对数据进行加锁，因为Watch监视的数据一旦被其他客户端修改则进行当前操作的客户端将会被回滚。这个命令被称为乐观锁（optimistic lock）。

注意⚠️：使用Watch监视频繁被修改的键可能会引起性能问题；原因：被频繁修改的键可能会导致大量获取锁操作的程序由于Wtach的键被修改而执行失败， 因而引起性能问题。